<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.525">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Advanced Statistics - ANOVA for Categorical</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><link rel="stylesheet" href="styles.css">
</head>
<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Advanced Statistics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="./review.html"> 
<span class="menu-text">Basic Review</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./confidence_intervals.html"> 
<span class="menu-text">Confidence Intervals</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./statistical_hypotheses.html"> 
<span class="menu-text">Statistical Hypotheses</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./linear_regression.html"> 
<span class="menu-text">Linear Regression</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./diagnostics.html"> 
<span class="menu-text">Diagnostics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./anova_categorical.html" aria-current="page"> 
<span class="menu-text">ANOVA for Categorical</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./model_selection.html"> 
<span class="menu-text">Model Selection</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./bayes_nets.html"> 
<span class="menu-text">Bayesian Networks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./glm.html"> 
<span class="menu-text">Generalized Linear Models</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./gam.html"> 
<span class="menu-text">Generalized Additive Models</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-github" role="button" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-github">
<li>
    <a class="dropdown-item" href="https://github.com/clickityKlein/Statistics">
 <span class="dropdown-text">Source Code</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/clickityKlein">
 <span class="dropdown-text">Carl Klein’s Main Page</span></a>
  </li>  
    </ul>
</li>
</ul>
</div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#one-way-anova" id="toc-one-way-anova" class="nav-link active" data-scroll-target="#one-way-anova">One-Way ANOVA</a>
  <ul class="collapse">
<li><a href="#degrees-of-freedom" id="toc-degrees-of-freedom" class="nav-link" data-scroll-target="#degrees-of-freedom">Degrees of Freedom</a></li>
  <li><a href="#f-statistic" id="toc-f-statistic" class="nav-link" data-scroll-target="#f-statistic">F-Statistic</a></li>
  <li><a href="#anova-table" id="toc-anova-table" class="nav-link" data-scroll-target="#anova-table">ANOVA Table</a></li>
  </ul>
</li>
  <li><a href="#anova-as-mlr" id="toc-anova-as-mlr" class="nav-link" data-scroll-target="#anova-as-mlr">ANOVA as MLR</a></li>
  <li>
<a href="#tukeys-honest-significance-test" id="toc-tukeys-honest-significance-test" class="nav-link" data-scroll-target="#tukeys-honest-significance-test">Tukey’s Honest Significance Test</a>
  <ul class="collapse">
<li><a href="#the-test" id="toc-the-test" class="nav-link" data-scroll-target="#the-test">The Test</a></li>
  </ul>
</li>
  <li>
<a href="#implementation" id="toc-implementation" class="nav-link" data-scroll-target="#implementation">Implementation</a>
  <ul class="collapse">
<li><a href="#one-way-anova-test" id="toc-one-way-anova-test" class="nav-link" data-scroll-target="#one-way-anova-test">One-Way ANOVA Test</a></li>
  <li><a href="#anova-as-mlr-1" id="toc-anova-as-mlr-1" class="nav-link" data-scroll-target="#anova-as-mlr-1">ANOVA as MLR</a></li>
  <li><a href="#analysis-of-variance-summary-table" id="toc-analysis-of-variance-summary-table" class="nav-link" data-scroll-target="#analysis-of-variance-summary-table">Analysis of Variance Summary Table</a></li>
  <li><a href="#tukey-test" id="toc-tukey-test" class="nav-link" data-scroll-target="#tukey-test">Tukey Test</a></li>
  <li><a href="#checking-assumptions" id="toc-checking-assumptions" class="nav-link" data-scroll-target="#checking-assumptions">Checking Assumptions</a></li>
  <li><a href="#what-if-assumptions-are-not-met" id="toc-what-if-assumptions-are-not-met" class="nav-link" data-scroll-target="#what-if-assumptions-are-not-met">What if Assumptions are not Met?</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">ANOVA for Categorical</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>We can use the f-distribution for ANOVAs (Analysis of Variance), which we’ve seen can be used to compare models, but they are also great for categorical variables.</p>
<blockquote class="blockquote">
<p>A linear model with only categorical predictors have traditionally been called analysis of variance (ANOVA). The purpose is to find whether statistically significant differences exist between the means of several independent groups.</p>
</blockquote>
<section id="one-way-anova" class="level1"><h1>One-Way ANOVA</h1>
<ul>
<li>
<span class="math inline">\(H_0\)</span>: <span class="math inline">\(\mu_A = \mu_B = \mu_C = \dots\)</span> for all groups/categories (i.e.&nbsp;the means of each group are the same)</li>
<li>
<span class="math inline">\(H_a\)</span>: at least one of the groups/categories’ means differ from the rest (i.e.&nbsp;at least one pair of means is not equal, or at least one sample mean is not equal to the others)</li>
</ul>
<p>We want to compare the global mean to all sub-means.</p>
<ul>
<li>Global: <span class="math inline">\(\frac{\sum \text{Values}}{\sum \text{Group Sizes}}\)</span>
</li>
<li>Group Means: <span class="math inline">\(\bar{y_i}\)</span>
</li>
</ul>
<p>We can variance in the data by the following:</p>
<ul>
<li>Total Sum of Squares: <span class="math inline">\(SST = \sum\limits_{i=1}^{I} \sum\limits_{j=1}^{n_i} (y_{ij} - \bar{\bar{y}})^2\)</span>
<ul>
<li>
<span class="math inline">\(i \in {1, \dots, I}\)</span>: group/category</li>
<li>
<span class="math inline">\(j \in {1, \dots, n_i}\)</span> value within group/category</li>
</ul>
</li>
<li>Within-Group Sum of Squares: <span class="math inline">\(SSW = \sum\limits_{i=1}^{I} \sum\limits_{j=1}^{n_i} (y_{ij} - \bar{y_i})^2\)</span>
<ul>
<li>how much groups are split from their own mean</li>
</ul>
</li>
<li>Between-Group sum of Squares: <span class="math inline">\(SSB = \sum\limits_{i=1}^{I} \sum\limits_{j=1}^{n_i} (\bar{y_i} - \bar{\bar{y}})^2\)</span>
<ul>
<li>how much groups are split from the total mean</li>
</ul>
</li>
<li>
<span class="math inline">\(SST = SSW + SSB\)</span>
<ul>
<li>goal: we want to know which term dominates between <span class="math inline">\(SSW\)</span> and <span class="math inline">\(SSB\)</span>
</li>
</ul>
</li>
</ul>
<p>Allowing for each group to have its own means accounts for <span class="math inline">\(\frac{SSB}{SST}\)</span> percent of the variability. This is very similar to an <span class="math inline">\(R^2\)</span>.</p>
<section id="degrees-of-freedom" class="level2"><h2 class="anchored" data-anchor-id="degrees-of-freedom">Degrees of Freedom</h2>
<p>Given <span class="math inline">\(I\)</span> number of groups/categories and <span class="math inline">\(N\)</span> total number of data points (across all groups/categories; recall that groups can have different number of data points):</p>
<ul>
<li><span class="math inline">\(SSB_{df} = I-1\)</span></li>
<li><span class="math inline">\(SSW_{df} = N-I\)</span></li>
</ul></section><section id="f-statistic" class="level2"><h2 class="anchored" data-anchor-id="f-statistic">F-Statistic</h2>
<p>Given:</p>
<ul>
<li>
<span class="math inline">\(H_0\)</span>: <span class="math inline">\(\mu_0 = \mu_1 = \mu_2\)</span>
</li>
<li>
<span class="math inline">\(H_a\)</span>: <span class="math inline">\(\mu_i \neq \mu_j\)</span> for some pair <span class="math inline">\(i, j\)</span>
</li>
</ul>
<p><span class="math inline">\(F_{stat} = \frac{SSB/SSB_{df}}{SSW/SSW_{df}} = \frac{\frac{SSB}{I-1}}{\frac{SSW}{N-I}}\)</span></p>
<p>Rejection Region: <span class="math inline">\(F_{\alpha,I-1,N-I}\)</span></p>
</section><section id="anova-table" class="level2"><h2 class="anchored" data-anchor-id="anova-table">ANOVA Table</h2>
<p>It’s common to summarize everything associated with the analysis of variance in a table.</p>
<p>Given the example:</p>
<table class="table">
<thead><tr class="header">
<th>Control</th>
<th>Diet A</th>
<th>Diet B</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>5</td>
<td>5</td>
</tr>
<tr class="even">
<td>2</td>
<td>3</td>
<td>6</td>
</tr>
<tr class="odd">
<td>1</td>
<td>4</td>
<td>7</td>
</tr>
</tbody>
</table>
<table class="table">
<thead><tr class="header">
<th>ANOVA</th>
<th>SS</th>
<th>DF</th>
<th>SS/DF</th>
<th><span class="math inline">\(F_{stat}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>between</td>
<td>24</td>
<td>2</td>
<td>12</td>
<td>12</td>
</tr>
<tr class="even">
<td>within</td>
<td>6</td>
<td>6</td>
<td>1</td>
<td></td>
</tr>
<tr class="odd">
<td>between</td>
<td>30</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table></section></section><section id="anova-as-mlr" class="level1"><h1>ANOVA as MLR</h1>
<p><span class="math inline">\(y = Control + \text{Effects of Groups} + Errors\)</span></p>
<p>A point in group <span class="math inline">\(i\)</span> would look like:</p>
<p><span class="math inline">\(y = \beta_0 + beta_i + \epsilon\)</span></p>
<p>We use indicator variables to set this up:</p>
<p><span class="math inline">\(x_{ij} = \begin{cases} 1 \\ 0 \end{cases}\)</span></p>
<p>We choose one group as control and create the model:</p>
<p><span class="math inline">\(y_{ij} = \mu_0 + \tau_1 x_{1j} + \tau_2 x_{2j} + \dots + \tau_{I-1} x_{{I-1}, j} + \epsilon_{ij}\)</span></p>
<p>where <span class="math inline">\(y_{ij}\)</span> is the <span class="math inline">\(j^{th}\)</span> response for the <span class="math inline">\(i^{th}\)</span> group</p>
<p>Recall our example:</p>
<table class="table">
<thead><tr class="header">
<th>Control</th>
<th>Diet A</th>
<th>Diet B</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>5</td>
<td>5</td>
</tr>
<tr class="even">
<td>2</td>
<td>3</td>
<td>6</td>
</tr>
<tr class="odd">
<td>1</td>
<td>4</td>
<td>7</td>
</tr>
</tbody>
</table>
<table class="table">
<thead><tr class="header">
<th><span class="math inline">\(y_{ij}\)</span></th>
<th><span class="math inline">\(y_{1j}\)</span></th>
<th><span class="math inline">\(y_{2j}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>3</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td>5</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td>4</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="odd">
<td>5</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td>6</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td>7</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table></section><section id="tukeys-honest-significance-test" class="level1"><h1>Tukey’s Honest Significance Test</h1>
<p>The F-test gives us a single conclusion on a model like this: groups matter. It doesn’t tell us how much or which groups matter. To answer this, we have to resort to more individual tests, like testing group A against group B, group A against the control, and group B against the control.</p>
<p>However, this sets us up for Type I Errors.</p>
<p>Given an error probability of <span class="math inline">\(\alpha\)</span>, what is the total probability we commit an error?</p>
<p><span class="math inline">\(P(\text{no error}) = \prod\limits_{i=1}^{I} P(\text{no error}_i) = (1-\alpha)^i\)</span></p>
<p>Therefore,</p>
<p><span class="math inline">\(P(error) = 1 - (1-alpha)^i\)</span></p>
<p>If we have 3 features and a set error rate of <span class="math inline">\(alpha = 0.05\)</span>,</p>
<p><span class="math inline">\(P(error) = 1 - (0.95)^3 \approx 0.14\)</span></p>
<blockquote class="blockquote">
<p>In summary, <span class="math inline">\(\alpha\)</span> for the F-statistic tells us groups matter. If and only if the F-statistic is significant, we can perform a careful version of pairwise testing between groups that accounts for both the fact that we’re doing multiple tests and that those tests aren’t independent.</p>
</blockquote>
<section id="the-test" class="level2"><h2 class="anchored" data-anchor-id="the-test">The Test</h2>
<p>Suppose we determine that some of the means are different. How can we tell which ones?</p>
<p>Tukey’s Honest Significance Test (HST/HSD) <em>post-hoc test for iff we reject the null hypothesis</em></p>
<ul>
<li>Hypothesis test for pairwise comparison of means: many tests using what’s called the studentized range distribution</li>
<li>Adjusts so that the probability of making a Type I error over all possible pairwise comparisons is kept at the original <span class="math inline">\(\alpha\)</span>
</li>
</ul>
<p>We can draw a conclusion from both the confidence interval and p-values output from this method (given a prescribed <span class="math inline">\(\alpha\)</span>.</p>
<ul>
<li>confidence interval [lower bound, upper bound]: if the lower bound and upper bound do not contain <span class="math inline">\(0\)</span>, we know that the difference between these groups is significant. <em>In particular, we can know if the difference is positive, since the lower bound of the confidence interval is greater than</em> <span class="math inline">\(0\)</span>.</li>
<li>p-value: given a confidence interval which does not contain <span class="math inline">\(0\)</span>, we would likely see a small enough p-value to reject the null hypothesis, indicating that the difference between the groups’ means is statistically significant.</li>
</ul>
<p>In other words, we’d be doing the same test as before, just pairwise:</p>
<ul>
<li>
<span class="math inline">\(H_0\)</span>: <span class="math inline">\(\mu_i = \mu_j = \mu_C = \dots\)</span> for two groups/categories <span class="math inline">\(i, j\)</span>
</li>
<li>
<span class="math inline">\(H_a\)</span>: <span class="math inline">\(\mu_i \neq \mu_j\)</span> for two groups/categories <span class="math inline">\(i, j\)</span>
</li>
</ul></section></section><section id="implementation" class="level1"><h1>Implementation</h1>
<blockquote class="blockquote">
<p>Import Libraries</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/car/">car</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'car' was built under R version 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'carData' was built under R version 4.3.3</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Creating the Dataset</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Control</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">DietA</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">DietB</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Control</span>,<span class="va">DietA</span>,<span class="va">DietB</span><span class="op">)</span></span>
<span><span class="va">df</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  Control DietA DietB
1       3     5     5
2       2     3     6
3       1     4     7</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Put into Long Format</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">longdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">group</span>, <span class="va">value</span><span class="op">)</span></span>
<span><span class="va">longdata</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>    group value
1 Control     3
2 Control     2
3 Control     1
4   DietA     5
5   DietA     3
6   DietA     4
7   DietB     5
8   DietB     6
9   DietB     7</code></pre>
</div>
</div>
<section id="one-way-anova-test" class="level2"><h2 class="anchored" data-anchor-id="one-way-anova-test">One-Way ANOVA Test</h2>
<blockquote class="blockquote">
<p>Perform Oneway ANOVA Test (var.equal = TRUE for this test, Var.equal = FALSE is another test)</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/oneway.test.html">oneway.test</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">longdata</span>, var.equal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<blockquote class="blockquote">
<p>The Results</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Fstat</span> <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">statistic</span></span>
<span><span class="va">pvalue</span> <span class="op">=</span> <span class="va">result</span><span class="op">$</span><span class="va">p.value</span></span>
<span></span>
<span><span class="va">Fstat</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code> F 
12 </code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pvalue</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0.008</code></pre>
</div>
</div>
</section><section id="anova-as-mlr-1" class="level2"><h2 class="anchored" data-anchor-id="anova-as-mlr-1">ANOVA as MLR</h2>
<p>We get a low enough p-value that we have enough evidence to reject the null hypothesis and conclude that at least one mean is different.</p>
<blockquote class="blockquote">
<p>What about the idea that ANOVA F-test is equivalent to linear regression where the features are binary categorical variables associated with group membership. We can recreate the 0, 1 dataframe.</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># x1: indicates membership in diet a</span></span>
<span><span class="co"># x2: indicates membership in diet b</span></span>
<span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">longdata</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">'DietA'</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">longdata</span><span class="op">$</span><span class="va">group</span> <span class="op">==</span> <span class="st">'DietB'</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">longdata</span><span class="op">$</span><span class="va">value</span></span>
<span></span>
<span><span class="va">y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 3 2 1 5 3 4 5 6 7</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 0 1 1 1 0 0 0</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 0 0 0 0 1 1 1</code></pre>
</div>
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dfRegression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">x1</span>, <span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">dfRegression</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  y x1 x2
1 3  0  0
2 2  0  0
3 1  0  0
4 5  1  0
5 3  1  0
6 4  1  0
7 5  0  1
8 6  0  1
9 7  0  1</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Perform MLR and compare the computed F-test</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">anova_regression</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dfRegression</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">anova_regression</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ ., data = dfRegression)

Residuals:
   Min     1Q Median     3Q    Max 
    -1     -1      0      1      1 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   2.0000     0.5774   3.464  0.01340 * 
x1            2.0000     0.8165   2.449  0.04983 * 
x2            4.0000     0.8165   4.899  0.00271 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1 on 6 degrees of freedom
Multiple R-squared:    0.8, Adjusted R-squared:  0.7333 
F-statistic:    12 on 2 and 6 DF,  p-value: 0.008</code></pre>
</div>
</div>
</section><section id="analysis-of-variance-summary-table" class="level2"><h2 class="anchored" data-anchor-id="analysis-of-variance-summary-table">Analysis of Variance Summary Table</h2>
<blockquote class="blockquote">
<p>Use <code><a href="https://rdrr.io/r/stats/aov.html">aov()</a></code> to create a summary table from original long data</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weightloss_study_aov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aov.html">aov</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">longdata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">weightloss_study_aov</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>            Df Sum Sq Mean Sq F value Pr(&gt;F)   
group        2     24      12      12  0.008 **
Residuals    6      6       1                  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section><section id="tukey-test" class="level2"><h2 class="anchored" data-anchor-id="tukey-test">Tukey Test</h2>
<blockquote class="blockquote">
<p>Use <code><a href="https://rdrr.io/r/stats/TukeyHSD.html">TukeyHSD()</a></code> on the aov summary to test which weight loss group(s) are statistically different</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># NOTE: can set significance level, i.e. TukeyHSD(aov_model, conf.level=0.95)</span></span>
<span><span class="va">tukey_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/TukeyHSD.html">TukeyHSD</a></span><span class="op">(</span><span class="va">weightloss_study_aov</span><span class="op">)</span></span>
<span><span class="va">tukey_test</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = value ~ group, data = longdata)

$group
              diff        lwr      upr     p adj
DietA-Control    2 -0.5052356 4.505236 0.1088670
DietB-Control    4  1.4947644 6.505236 0.0064937
DietB-DietA      2 -0.5052356 4.505236 0.1088670</code></pre>
</div>
</div>
<blockquote class="blockquote">
<p>Plotting the Tukey Test Results</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">tukey_test</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="anova_categorical_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section><section id="checking-assumptions" class="level2"><h2 class="anchored" data-anchor-id="checking-assumptions">Checking Assumptions</h2>
<p>Specifically, we want to check:</p>
<ul>
<li>homogeniety of variance assumption</li>
<li>normality assumption</li>
</ul>
<blockquote class="blockquote">
<p>Plotting</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">weightloss_study_aov</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="anova_categorical_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="anova_categorical_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="anova_categorical_files/figure-html/unnamed-chunk-11-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="anova_categorical_files/figure-html/unnamed-chunk-11-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<blockquote class="blockquote">
<p>Levenes’ Test (constant variance)</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/car/man/leveneTest.html">leveneTest</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">longdata</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stderr">
<pre><code>Warning in leveneTest.default(y = y, group = group, ...): group coerced to
factor.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Levene's Test for Homogeneity of Variance (center = median)
      Df F value Pr(&gt;F)
group  2       0      1
       6               </code></pre>
</div>
</div>
<ul>
<li>
<span class="math inline">\(H_0\)</span>: homogeneity of variance across all groups</li>
<li>
<span class="math inline">\(H_a\)</span>: homogeneity of variance condition violated</li>
</ul>
<blockquote class="blockquote">
<p>Shapiro-Wilk’s test (normality)</p>
</blockquote>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">aov_residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">weightloss_study_aov</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/shapiro.test.html">shapiro.test</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">aov_residuals</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  aov_residuals
W = 0.82304, p-value = 0.03729</code></pre>
</div>
</div>
</section><section id="what-if-assumptions-are-not-met" class="level2"><h2 class="anchored" data-anchor-id="what-if-assumptions-are-not-met">What if Assumptions are not Met?</h2>
<p>When assumptions are not met, we can use a non-parametric test known as the Kruskal-Wallis rank sum test, which determines whether or not there is a statistically significant difference between the medians of three or more independent groups. <em>Note this returns a chi-squared value</em>.</p>
<ul>
<li>
<span class="math inline">\(H_0\)</span>: the median is equal across all groups</li>
<li>
<span class="math inline">\(H_a\)</span>: the median is not equal across all groups</li>
</ul>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/kruskal.test.html">kruskal.test</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">group</span>, data <span class="op">=</span> <span class="va">longdata</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>
    Kruskal-Wallis rank sum test

data:  value by group
Kruskal-Wallis chi-squared = 6.5311, df = 2, p-value = 0.03818</code></pre>
</div>
</div>
<p>We can further determine which groups have significant differences between them by using <code><a href="https://rdrr.io/r/stats/pairwise.wilcox.test.html">pairwise.wilcox.test()</a></code>.</p>


</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    const typesetMath = (el) => {
      if (window.MathJax) {
        // MathJax Typeset
        window.MathJax.typeset([el]);
      } else if (window.katex) {
        // KaTeX Render
        var mathElements = el.getElementsByClassName("math");
        var macros = [];
        for (var i = 0; i < mathElements.length; i++) {
          var texText = mathElements[i].firstChild;
          if (mathElements[i].tagName == "SPAN") {
            window.katex.render(texText.data, mathElements[i], {
              displayMode: mathElements[i].classList.contains('display'),
              throwOnError: false,
              macros: macros,
              fleqn: false
            });
          }
        }
      }
    }
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        typesetMath(container);
        return container.innerHTML
      } else {
        typesetMath(note);
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      typesetMath(note);
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="https://clickityklein.github.io/Carl-Klein/">About Carl Klein</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>